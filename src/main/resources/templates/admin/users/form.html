<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${user.id != null} ? 'Редактирование пользователя - TARENO' : 'Создание пользователя - TARENO'">Форма пользователя</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div th:replace="~{fragments/nav :: navbar}"></div>
<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="fas" th:classappend="${user.id != null} ? 'fa-user-edit' : 'fa-user-plus'"></i>
                    <span th:text="${user.id != null} ? 'Редактирование пользователя' : 'Создание пользователя'"></span>
                </h1>
                <p class="page-subtitle" th:text="${user.id != null} ?
                       'Обновление информации о пользователе' :
                       'Добавление нового пользователя в систему'"></p>
            </div>
            <div class="col-md-4 text-end">
                <a th:href="@{/admin/users}" class="btn btn-light">
                    <i class="fas fa-arrow-left me-2"></i>Назад к списку
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="form-card">
                <form th:action="${user.id != null} ? @{/admin/users/update/{id}(id=${user.id}) : @{/admin/users/create}"
                      method="post" th:object="${user}">

                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="fas fa-user"></i>Основная информация
                        </h3>

                        <div class="mb-3">
                            <label class="form-label">Имя пользователя *</label>
                            <input type="text" th:field="*{username}" class="form-control"
                                   placeholder="Введите имя пользователя" required
                                   th:readonly="${user.id != null}"/>
                            <div class="form-text">От 3 до 50 символов. После создания изменить нельзя.</div>
                            <div th:if="${#fields.hasErrors('username')}" class="text-danger">
                                <small th:errors="*{username}"></small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" th:field="*{email}" class="form-control"
                                   placeholder="email@example.com" required />
                            <div th:if="${#fields.hasErrors('email')}" class="text-danger">
                                <small th:errors="*{email}"></small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" th:text="${user.id != null} ? 'Новый пароль' : 'Пароль *'"></label>
                            <input type="password" th:field="*{password}" class="form-control"
                                   placeholder="Введите пароль"
                                   th:required="${user.id == null}" />
                            <div class="form-text" th:if="${user.id != null}">
                                Оставьте пустым, если не хотите менять пароль
                            </div>
                            <div class="form-text" th:unless="${user.id != null}">
                                Минимум 6 символов
                            </div>
                            <div th:if="${#fields.hasErrors('password')}" class="text-danger">
                                <small th:errors="*{password}"></small>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">
                            <i class="fas fa-user-shield"></i>Права доступа
                        </h3>

                        <div class="mb-3">
                            <label class="form-label">Роль пользователя *</label>
                            <select th:field="*{role}" class="form-select" required>
                                <option value="">Выберите роль</option>
                                <option value="ROLE_USER">Обычный пользователь</option>
                                <option value="ROLE_MANAGER">Менеджер</option>
                                <option value="ROLE_ADMIN">Администратор</option>
                            </select>
                            <div class="form-text">
                                <strong>Роли:</strong><br>
                                • <strong>Пользователь</strong> - просмотр товаров<br>
                                • <strong>Менеджер</strong> - управление товарами, заказами, клиентами<br>
                                • <strong>Администратор</strong> - полный доступ ко всем функциям
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" th:field="*{enabled}">
                                <label class="form-check-label">Активный пользователь</label>
                            </div>
                            <div class="form-text">
                                Если выключено, пользователь не сможет войти в систему
                            </div>
                        </div>
                    </div>
                    <div th:if="${user.id != null}" class="form-section">
                        <h3 class="form-section-title">
                            <i class="fas fa-info-circle"></i>Информация о пользователе
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label>ID пользователя:</label>
                                    <span th:text="${user.id}" class="text-muted">-</span>
                                </div>
                                <div class="info-item">
                                    <label>Дата регистрации:</label>
                                    <span th:text="${#temporals.format(user.createdAt, 'dd.MM.yyyy HH:mm')}"
                                          class="text-muted">-</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label>Последняя активность:</label>
                                    <span th:if="${user.lastActivity}"
                                          th:text="${#temporals.format(user.lastActivity, 'dd.MM.yyyy HH:mm')}"
                                          class="text-muted">-</span>
                                    <span th:unless="${user.lastActivity}" class="text-muted">—</span>
                                </div>
                                <div class="info-item">
                                    <label>Статус:</label>
                                    <span th:if="${user.enabled}" class="badge bg-success">Активен</span>
                                    <span th:unless="${user.enabled}" class="badge bg-danger">Заблокирован</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-12 d-flex justify-content-between">
                            <a th:href="@{/admin/users}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Отмена
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas" th:classappend="${user.id != null} ? 'fa-save' : 'fa-user-plus'"></i>
                                    <span th:text="${user.id != null} ? 'Обновить пользователя' : 'Создать пользователя'"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div th:if="${user.id != null && !user.enabled}" class="alert alert-warning mt-4">
                <div class="d-flex">
                    <i class="fas fa-exclamation-triangle me-3 mt-1"></i>
                    <div>
                        <strong>Внимание!</strong> Этот пользователь заблокирован и не может войти в систему.
                    </div>
                </div>
            </div>
            <div th:if="${user.id != null && user.lastActivity != null && user.lastActivity.isBefore(#temporals.createNow().minusMinutes(15))}"
                 class="alert alert-info mt-4">
                <div class="d-flex">
                    <i class="fas fa-clock me-3 mt-1"></i>
                    <div>
                        <strong>Информация:</strong> Пользователь не активен более 15 минут.
                        Последняя активность:
                        <span th:text="${#temporals.format(user.lastActivity, 'dd.MM.yyyy HH:mm')}"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Динамическое изменение подсказки для пароля
    const passwordField = document.querySelector('input[type="password"]');
    const userId = [[${user.id}]];

    if (userId) {
        passwordField.placeholder = "Введите новый пароль (оставьте пустым, чтобы не менять)";
    }

    // Подсветка выбранной роли
    const roleSelect = document.querySelector('select[name="role"]');
    function updateRoleStyle() {
        const value = roleSelect.value;
        roleSelect.className = 'form-select ' + (value ? 'role-' + value.toLowerCase().replace('role_', '') : '');
    }

    roleSelect.addEventListener('change', updateRoleStyle);
    updateRoleStyle(); // Инициализация при загрузке
</script>
</body>
</html>