<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru"
      th:with="theme=${currentTheme != null ? currentTheme : 'light'}"
      th:attr="data-theme=${currentTheme}">
<head>
    <title>Оформление заказа</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/nav.css}">
    <link rel="stylesheet" th:href="@{/css/oformzakaz.css}">
</head>
<body>
<div th:replace="~{fragments/nav :: navbar}"></div>

<main class="container mt-4">
    <!-- Flash сообщение -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert" id="successAlert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <h1>Оформление заказа</h1>

    <div class="row">
        <!-- Товары в заказе -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Товары в заказе</h5>
                </div>
                <div class="card-body">
                    <div th:each="item : ${cartItems}" class="cart-item mb-3 pb-3 border-bottom">
                        <div class="row align-items-center">
                            <div class="col-2">
                                <img th:if="${item.product.images != null and not item.product.images.empty}"
                                     th:src="@{${item.product.images[0].imageUrl}}"
                                     th:alt="${item.product.name}"
                                     class="img-fluid rounded">
                                <div th:unless="${item.product.images != null and not item.product.images.empty}"
                                     class="bg-light rounded d-flex align-items-center justify-content-center"
                                     style="width: 80px; height: 80px;">
                                    <i class="fas fa-tshirt text-muted"></i>
                                </div>
                            </div>
                            <div class="col-6">
                                <h6 th:text="${item.product.name}"></h6>
                                <div class="text-muted small">
                                    <span th:if="${item.size}">Размер: <span th:text="${item.size}"></span></span>
                                    <span th:if="${item.color}">, Цвет: <span th:text="${item.color}"></span></span>
                                </div>
                                <div class="text-muted small">Количество: <span th:text="${item.quantity}"></span></div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="fw-bold" th:text="'₽' + ${#numbers.formatDecimal(item.product.price * item.quantity, 0, 'COMMA', 0, 'POINT')}"></div>
                                <div th:if="${item.product.originalPrice > item.product.price}"
                                     class="text-muted text-decoration-line-through small"
                                     th:text="'₽' + ${#numbers.formatDecimal(item.product.originalPrice * item.quantity, 0, 'COMMA', 0, 'POINT')}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Итоги по товарам -->
                    <div class="row mt-3">
                        <div class="col-6">
                            <strong>Итого товаров:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <strong th:text="'₽' + ${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')}"></strong>
                        </div>
                    </div>
                </div>
            </div>

            <form th:action="@{/checkout/place-order}" method="post" th:object="${orderRequest}" id="orderForm">
                <!-- Email для чека -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Email для получения чека</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="useProfileEmail"
                                       id="useProfileEmail" value="true"
                                       th:checked="${orderRequest.useProfileEmail}">
                                <label class="form-check-label" for="useProfileEmail">
                                    Отправить чек на email из профиля:
                                    <strong th:text="${user.email}"></strong>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="useProfileEmail"
                                       id="useCustomEmail" value="false"
                                       th:checked="${!orderRequest.useProfileEmail}">
                                <label class="form-check-label" for="useCustomEmail">
                                    Указать другой email для чека
                                </label>
                            </div>
                        </div>

                        <!-- Поле для ввода email показывается всегда, но required только при выборе другого email -->
                        <div class="mb-3">
                            <label class="form-label">Email для получения чека
                                <span th:if="${!orderRequest.useProfileEmail}" class="text-danger">*</span>
                            </label>
                            <input type="email" class="form-control" name="receiptEmail"
                                   th:value="${orderRequest.receiptEmail}"
                                   th:required="${!orderRequest.useProfileEmail}"
                                   placeholder="Введите email для получения чека о заказе">
                            <small class="form-text text-muted">
                                На этот email будет отправлен чек с информацией о вашем заказе
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Данные доставки -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Данные доставки</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Адрес доставки *</label>
                            <input type="text" class="form-control" name="shippingAddress"
                                   th:value="${user?.address ?: ''}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Способ оплаты *</label>
                            <select class="form-control" name="paymentMethod" required>
                                <option value="CARD">Банковская карта</option>
                                <option value="CASH">Наличные при получении</option>
                            </select>
                        </div>

                        <!-- Поля для карты - всегда видны, но required только при выборе карты -->
                        <div class="mb-3">
                            <label class="form-label">Номер карты</label>
                            <input type="text" class="form-control" name="cardNumber"
                                   placeholder="0000 0000 0000 0000" maxlength="19">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Срок действия</label>
                                <input type="text" class="form-control" name="cardExpiry"
                                       placeholder="ММ/ГГ" maxlength="5">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-control" name="cardCvv"
                                       placeholder="000" maxlength="3">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Имя владельца карты</label>
                            <input type="text" class="form-control" name="cardHolder"
                                   placeholder="IVAN IVANOV">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Комментарий к заказу</label>
                            <textarea class="form-control" name="customerNotes" rows="3"
                                      placeholder="Дополнительные пожелания к заказу"></textarea>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a th:href="@{/cart}" class="btn btn-secondary me-md-2">Назад в корзину</a>
                    <button type="submit" class="btn btn-primary btn-lg">Подтвердить заказ</button>
                </div>
            </form>
        </div>

        <!-- Итоговая информация -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Итог заказа</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Товары (<span th:text="${cartItems.size()}"></span> шт.):</span>
                        <span th:text="'₽' + ${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')}"></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Доставка:</span>
                        <span th:if="${deliveryCost == 0}" class="text-success">БЕСПЛАТНО</span>
                        <span th:if="${deliveryCost > 0}" th:text="'₽' + ${#numbers.formatDecimal(deliveryCost, 0, 'COMMA', 0, 'POINT')}"></span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold fs-5">
                        <span>К оплате:</span>
                        <span th:text="'₽' + ${#numbers.formatDecimal(finalTotal, 0, 'COMMA', 0, 'POINT')}"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    // Автоматическое скрытие success сообщения и редирект через 5 секунд
    document.addEventListener('DOMContentLoaded', function() {
        const successAlert = document.getElementById('successAlert');
        if (successAlert) {
            setTimeout(function() {
                // Скрываем сообщение
                const alert = new bootstrap.Alert(successAlert);
                alert.close();

                // Редирект на страницу истории заказов через 1 секунду после скрытия
                setTimeout(function() {
                    window.location.href = '/order-history';
                }, 1000);

            }, 5000); // 5 секунд
        }
    });
</script>
</body>
</html>