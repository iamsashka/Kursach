<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru"
      th:with="theme=${currentTheme != null ? currentTheme : 'light'}"
      th:attr="data-theme=${currentTheme}">
<head>
    <title>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã - TARENO</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/nav.css}">
    <link rel="stylesheet" th:href="@{/css/favorite.css}">
</head>
<body class="favorites-page">
<div th:replace="~{fragments/nav :: navbar}"></div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div th:if="${success}" class="alert alert-success alert-dismissible fade show mb-0" role="alert" style="border-radius: 0; border: none;">
    <div class="container">
        <i class="fas fa-check me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</div>

<div th:if="${error}" class="alert alert-danger alert-dismissible fade show mb-0" role="alert" style="border-radius: 0; border: none;">
    <div class="container">
        <i class="fas fa-times me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ -->
<div th:if="${limitReached}" class="alert alert-warning alert-dismissible fade show mb-0" role="alert" style="border-radius: 0; border: none;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ!</strong><br>
                <small>
                    –£ –≤–∞—Å —É–∂–µ 100 —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º. –•–æ—Ç–∏—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å
                    "<span th:text="${oldestProductName ?: '—Å—Ç–∞—Ä—ã–π —Ç–æ–≤–∞—Ä'}"></span>"
                    –Ω–∞ "<span th:text="${newProductName ?: '–Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä'}"></span>"?
                </small>
            </div>
            <div class="col-md-4 text-end">
                <form th:action="@{/api/favorites/replace-oldest}" method="post" class="d-inline">
                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" name="newProductId" th:value="${newProductId}">
                    <input type="hidden" name="oldestFavoriteId" th:value="${oldestFavoriteId}">
                    <button type="submit" class="btn btn-sm btn-outline-dark me-2">
                        <i class="fas fa-sync-alt me-1"></i>–ó–∞–º–µ–Ω–∏—Ç—å
                    </button>
                </form>
                <a th:href="@{/api/favorites/page}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>–û—Ç–º–µ–Ω–∞
                </a>
            </div>
        </div>
    </div>
</div>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div class="favorites-header">
    <div class="container">
        <h1 class="page-title">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</h1>
        <p class="page-subtitle">–í–∞—à–∞ –ª–∏—á–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è</p>
    </div>
</div>

<div class="container favorites-container">
    <div class="favorites-content">
        <div class="row">
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="col-lg-8">
                <div th:if="${favorites != null and !favorites.empty}">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º -->
                    <div class="d-flex justify-content-between align-items-center mb-5">
                        <div>
                            <h4 class="favorites-count mb-0">
                                <i class="fas fa-heart me-2"></i>
                                –ö–æ–ª–ª–µ–∫—Ü–∏—è: <span th:text="${favorites.size()}"></span>/100 –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                            </h4>
                            <small class="text-muted" th:if="${favorites.size() >= 90}" style="color: #dc3545 !important;">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                –õ–∏–º–∏—Ç –ø–æ—á—Ç–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
                            </small>
                            <small class="text-muted" th:if="${favorites.size() >= 80 and favorites.size() < 90}" style="color: #ffc107 !important;">
                                <i class="fas fa-info-circle me-1"></i>
                                –û—Å—Ç–∞–ª–æ—Å—å –º–µ—Å—Ç: <span th:text="100 - ${favorites.size()}"></span>
                            </small>
                            <small class="text-muted" th:if="${favorites.size() < 80}">
                                –í–∞—à–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏
                            </small>
                        </div>
                        <a th:href="@{/catalog}" class="btn btn-favorite">
                            <i class="fas fa-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë
                        </a>
                    </div>

                    <!-- –°–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ -->
                    <div class="favorites-list">
                        <div class="favorite-item" th:each="favorite, stat : ${favorites}">
                            <div class="favorite-item-content">
                                <div class="favorite-item-row">
                                    <!-- –ù–æ–º–µ—Ä –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ -->
                                    <div class="item-number">
                                        <span th:text="${stat.count}"></span>
                                    </div>

                                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
                                    <div class="product-image-container">
                                        <img th:if="${favorite?.product?.mainImage != null}"
                                             th:src="${favorite?.product?.mainImage}"
                                             th:alt="${favorite?.product?.name ?: '–¢–æ–≤–∞—Ä'}"
                                             class="product-image">
                                        <div th:unless="${favorite?.product?.mainImage != null}"
                                             class="loading-placeholder w-100 h-100 d-flex align-items-center justify-content-center">
                                            <i class="fas fa-shopping-bag fa-2x"></i>
                                        </div>
                                    </div>

                                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                                    <div class="product-info">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h6 th:text="${favorite?.product?.name ?: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞'}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h6>
                                            <small class="text-muted" th:if="${favorite?.createdAt != null}">
                                                <span th:text="${#temporals.format(favorite.createdAt, 'dd.MM.yy')}"></span>
                                            </small>
                                        </div>
                                        <p class="brand-name" th:text="${favorite?.product?.brand?.name ?: '–ë—Ä–µ–Ω–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'}">–ë—Ä–µ–Ω–¥</p>

                                        <!-- –ù–∞–ª–∏—á–∏–µ –∏ —Ç–µ–≥–∏ -->
                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                            <span th:if="${favorite?.product?.stockQuantity > 5}" class="stock-badge">
                                                <i class="fas fa-check me-1"></i>–í –Ω–∞–ª–∏—á–∏–∏
                                            </span>
                                            <span th:if="${favorite?.product?.stockQuantity > 0 and favorite?.product?.stockQuantity <= 5}"
                                                  class="low-stock-badge">
                                                <i class="fas fa-exclamation-triangle me-1"></i>–ú–∞–ª–æ –≤ –Ω–∞–ª–∏—á–∏–∏
                                            </span>
                                            <span th:if="${favorite?.product?.stockQuantity == 0}"
                                                  class="out-of-stock-badge">
                                                <i class="fas fa-times me-1"></i>–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                                            </span>
                                            <span th:if="${favorite?.product?.originalPrice != null and favorite?.product?.originalPrice > favorite?.product?.price}"
                                                  class="sale-badge">
                                                <i class="fas fa-bolt me-1"></i>–°–∫–∏–¥–∫–∞
                                            </span>
                                        </div>

                                        <!-- –¶–µ–Ω–∞ -->
                                        <div class="price-section">
                                            <span class="current-price"
                                                  th:text="'‚ÇΩ' + ${#numbers.formatDecimal(favorite?.product?.price ?: 0, 0, 'COMMA', 2, 'POINT')}"></span>
                                            <span th:if="${favorite?.product?.originalPrice != null and favorite?.product?.originalPrice > favorite?.product?.price}"
                                                  class="original-price"
                                                  th:text="'‚ÇΩ' + ${#numbers.formatDecimal(favorite?.product?.originalPrice, 0, 'COMMA', 2, 'POINT')}">
                                            </span>
                                            <span th:if="${favorite?.product?.originalPrice != null and favorite?.product?.originalPrice > favorite?.product?.price}"
                                                  class="discount-badge"
                                                  th:text="'-' + ${((favorite?.product?.originalPrice - favorite?.product?.price) / favorite?.product?.originalPrice * 100).intValue()} + '%'">
                                            </span>
                                        </div>
                                    </div>

                                    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                                    <div class="action-buttons">
                                        <!-- –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É -->
                                        <form th:action="@{/cart/add}" method="post" class="favorite-form">
                                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                            <input type="hidden" name="productId" th:value="${favorite?.product?.id}">
                                            <input type="hidden" name="quantity" value="1">
                                            <input type="hidden" name="size" value="M">
                                            <input type="hidden" name="color"
                                                   th:if="${favorite?.product?.colors != null and !favorite.product.colors.empty}"
                                                   th:value="${favorite.product.colors[0].name}">
                                            <input type="hidden" name="color" th:unless="${favorite?.product?.colors != null and !favorite.product.colors.empty}" value="Black">
                                            <button type="submit"
                                                    class="btn btn-favorite"
                                                    th:disabled="${favorite?.product?.stockQuantity == 0}">
                                                <i class="fas fa-shopping-cart me-2"></i>
                                                <span th:if="${favorite?.product?.stockQuantity > 0}">–í –∫–æ—Ä–∑–∏–Ω—É</span>
                                                <span th:if="${favorite?.product?.stockQuantity == 0}">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                                            </button>
                                        </form>

                                        <!-- –ü–æ–¥—Ä–æ–±–Ω–µ–µ -->
                                        <a th:href="@{/products/{id}(id=${favorite?.product?.id})}"
                                           class="btn btn-favorite">
                                            <i class="fas fa-eye me-2"></i>–ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                        </a>

                                        <!-- –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->
                                        <form th:action="@{/api/favorites/remove-redirect}" method="post" class="favorite-form">
                                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                            <input type="hidden" name="productId" th:value="${favorite?.product?.id}">
                                            <button type="submit" class="btn btn-favorite btn-remove">
                                                <i class="fas fa-trash me-2"></i>–£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->
                <div th:unless="${favorites != null and !favorites.empty}" class="empty-favorites">
                    <div class="empty-favorites-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <h3>–í–∞—à–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—è –∂–¥—ë—Ç –æ—Ç–∫—Ä—ã—Ç–∏–π</h3>
                    <p>–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è —Ç–æ–≤–∞—Ä—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –∏—Ö.<br>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –∏–¥–µ–∞–ª—å–Ω—É—é –ø–æ–¥–±–æ—Ä–∫—É.</p>
                    <div class="d-flex gap-3 justify-content-center flex-wrap">
                        <a th:href="@{/catalog}" class="btn btn-favorite btn-lg">
                            <i class="fas fa-compass me-2"></i>–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥
                        </a>
                        <a th:href="@{/catalog/bestsellers}" class="btn btn-favorite btn-lg">
                            <i class="fas fa-crown me-2"></i>–•–∏—Ç—ã –ø—Ä–æ–¥–∞–∂
                        </a>
                    </div>
                </div>
            </div>

            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="col-lg-4" th:if="${favorites != null and !favorites.empty}">
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ª–∏–º–∏—Ç–∞ -->
                <div class="limit-card" th:if="${favorites.size() >= 80}">
                    <h6>
                        <i class="fas fa-tachometer-alt me-2"
                           th:classappend="${favorites.size() >= 95} ? 'text-danger' : 'text-warning'"></i>
                        –õ–∏–º–∏—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                    </h6>
                    <div class="limit-progress">
                        <div class="limit-label">
                            <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:</span>
                            <span th:text="${favorites.size()} + '/100'"></span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar"
                                 th:classappend="${favorites.size() >= 95} ? 'bg-danger' : 'bg-warning'"
                                 th:style="'width: ' + ${favorites.size()} + '%;'"></div>
                        </div>
                        <div class="limit-message mt-2">
                            <small th:if="${favorites.size() >= 95}" class="text-danger">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                –õ–∏–º–∏—Ç –ø–æ—á—Ç–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç! –ú–∞–∫—Å–∏–º—É–º - 100 —Ç–æ–≤–∞—Ä–æ–≤.
                            </small>
                            <small th:if="${favorites.size() >= 80 and favorites.size() < 95}" class="text-warning">
                                <i class="fas fa-info-circle me-1"></i>
                                –õ–∏–º–∏—Ç: 100 —Ç–æ–≤–∞—Ä–æ–≤. –û—Å—Ç–∞–ª–æ—Å—å –º–µ—Å—Ç: <span th:text="100 - ${favorites.size()}"></span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ -->
                <div class="stats-card">
                    <h5>
                        <i class="fas fa-chart-pie me-2"></i>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </h5>

                    <div class="stat-item">
                        <div class="stat-info">
                            <i class="fas fa-box-open"></i>
                            <span>–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∑–∞–∫–∞–∑–∞</span>
                        </div>
                        <span class="stat-value" th:text="${#lists.size(favorites.?[product?.stockQuantity > 0])}"></span>
                    </div>

                    <div class="stat-item">
                        <div class="stat-info">
                            <i class="fas fa-tag"></i>
                            <span>–¢–æ–≤–∞—Ä—ã —Å–æ —Å–∫–∏–¥–∫–æ–π</span>
                        </div>
                        <span class="stat-value" th:text="${#lists.size(favorites.?[product?.originalPrice != null and product?.originalPrice > product?.price])}"></span>
                    </div>

                    <div class="stat-item">
                        <div class="stat-info">
                            <i class="fas fa-star"></i>
                            <span>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</span>
                        </div>
                        <span class="stat-value" th:text="${favorites.size()}"></span>
                    </div>
                </div>

                <!-- –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã -->
                <div class="fun-facts-card">
                    <h6>
                        <i class="fas fa-gem me-2"></i>
                        –û –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                    </h6>
                    <div class="fact-content">
                        <p th:if="${favorites.size() >= 20}">üéâ –í–ø–µ—á–∞—Ç–ª—è—é—â–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è! –ë–æ–ª–µ–µ 20 –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.</p>
                        <p th:if="${favorites.size() >= 10 and favorites.size() < 20}">‚ú® –û—Ç–ª–∏—á–Ω—ã–π –≤–∫—É—Å! –í–∞—à–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—è —Ä–∞—Å—Ç—ë—Ç.</p>
                        <p th:if="${favorites.size() >= 5 and favorites.size() < 10}">üí´ –•–æ—Ä–æ—à–µ–µ –Ω–∞—á–∞–ª–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –Ω–∞–ø–æ–ª–Ω—è—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é.</p>
                        <p th:if="${favorites.size() < 5}">üåü –ù–∞—á–Ω–∏—Ç–µ —Å –º–∞–ª–æ–≥–æ - –∫–∞–∂–¥–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.</p>

                        <div class="fact-tip mt-3">
                            <i class="fas fa-lightbulb"></i>
                            <span>–°–æ–≤–µ—Ç: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –≥–∞—Ä–¥–µ—Ä–æ–±–∞</span>
                        </div>
                    </div>
                </div>

                <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="quick-actions-card">
                    <h6>
                        <i class="fas fa-bolt me-2"></i>
                        –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                    </h6>
                    <div class="actions-list">
                        <a th:href="@{/catalog}" class="action-item">
                            <i class="fas fa-newspaper"></i>
                            <span>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–æ–≤–∏–Ω–∫–∏</span>
                        </a>
                        <a th:href="@{/catalog}" class="action-item">
                            <i class="fas fa-percentage"></i>
                            <span>–¢–æ–≤–∞—Ä—ã —Å–æ —Å–∫–∏–¥–∫–æ–π</span>
                        </a>
                        <a th:href="@{/catalog}" class="action-item">
                            <i class="fas fa-fire"></i>
                            <span>–ë–µ—Å—Ç—Å–µ–ª–ª–µ—Ä—ã</span>
                        </a>
                        <a th:href="@{/catalog}" class="action-item">
                            <i class="fas fa-layer-group"></i>
                            <span>–í—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>